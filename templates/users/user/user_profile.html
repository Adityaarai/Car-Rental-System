{% extends 'base.html' %} 
{% load static %} 
{% block title %} VROOM - User profile{% endblock %} 

{% block content %}

<div class="main-container">
  <div class="details">
    <h1>User Profile</h1>
    {% for message in messages %} 
      {% if message.tags == 'error' %}
        <div class="alert alert-danger" role="alert">{{ message }}</div>
      {% elif message.tags == 'success' %}
        <div class="alert alert-success" role="alert">{{ message }}</div>
      {% endif %} 
    {% endfor %}

    <!--buttons in profile page-->
    <button class="button" id="profileBtn">Profile</button>
    <button class="button" id="myBookingsBtn">My Bookings</button>
    {% if user.is_staff %}
    <a href="{% url 'distributor_dashboard' %}">
      <button class="button">Distributor View</button>
    </a>
    {% else %}
    <a href="{% url 'register_distributor' %}">
      <button class="button" id="distributorRequest">Register as a Distributor</button>
    </a>
    {% endif %}
    
    
    

    <!-- My Bookings dropdown -->
    <div id="myBookingsDropdown" style="display: none">
      <button class="booking-btn" id="pendingBtn">Pending</button>
      <button class="booking-btn" id="approvedBtn">Approved</button>
      <button class="booking-btn" id="paidBtn">Paid</button>
      <button class="booking-btn" id="completedBtn">Completed</button>
    </div>

    <!-- Profile section -->
    <div id="profileSection" class="section">
      <h2>Profile Information</h2>
      <p style="margin-top: 20px; margin-bottom: 10px">
        First Name: <span id="firstName">{{ user_profile.user.first_name }}</span>
      </p>
      <p style="margin-bottom: 10px">
        Last Name: <span id="lastName">{{ user_profile.user.last_name }}</span>
      </p>
      <p style="margin-bottom: 10px">
        Username: <span id="username">{{ user_profile.user.username }}</span>
      </p>
      <p style="margin-bottom: 10px">
        Email: <span id="email">{{ user_profile.user.email }}</span>
      </p>
      <p style="margin-bottom: 10px">
        Address: <span id="address">{{ user_profile.address }}</span>
      </p>
      <p style="margin-bottom: 10px">
        License Photo:
        <span id="licenseNumber">
          {% if user_profile.license_photo %}
            <a href="#" onclick="showImage('{{ user_profile.license_photo.url }}')">View License</a>
          {% else %}
            Not Uploaded
          {% endif %}
        </span>
      </p>
      <p style="margin-bottom: 10px">
        Contact Number: <span id="contactNumber">{{ user_profile.contact }}</span>
      </p>

      <button class="button" id="editProfileBtn">Edit Profile</button>
      <button class="button" id="changePasswordBtn">Change Password</button>

      <div id="editProfileForm" style="display: none">
        <br>
        <h2>Edit Profile form</h2>
        <form
          id="updateProfileForm"
          method="POST"
          action="{% url 'user_profile' %}"
          enctype="multipart/form-data"
        >
          {% csrf_token %}
          <label for="editFirstName">First Name:</label>
          <input
            type="text"
            id="editFirstName"
            name="first_name"
            value="{{ user_profile.user.first_name }}"
          /><br />

          <label for="editLastName">Last Name:</label>
          <input
            type="text"
            id="editLastName"
            name="last_name"
            value="{{ user_profile.user.last_name }}"
          /><br />

          <label for="editUsername">Username:</label>
          <input
            type="text"
            id="editUsername"
            name="username"
            value="{{ user_profile.user.username }}"
          /><br />

          <label for="editEmail">Email:</label>
          <input
            type="email"
            id="editEmail"
            name="email"
            value="{{ user_profile.user.email }}"
          /><br />

          <label for="editAddress">Address:</label>
          <input
            type="text"
            id="editAddress"
            name="address"
            value="{{ user_profile.address }}"
          />
          <br />

          <label for="editLicenseNumber">License Photo:</label>
          {% if user_profile.license_photo %}
            <img id="license_photo" src="{{ user_profile.license_photo.url }}" alt="">
          {% else %}
            No file uploaded
          {% endif %}
          <input
            type="file"
            id="editLicensePhoto"
            name="license_photo"
          />
          <br />
          <label for="editContact">Contact Number:</label>
          <input
            type="text"
            id="editContact"
            name="contact"
            value="{{ user_profile.contact }}"
          />
          <br />

          <span id="contactError" style="color: red; display: none"
            >Contact number must be a 10-digit number.</span
          ><br />

          <button class="button" type="submit" name="updateProfile">Update Profile</button>
        </form>
      </div>
    </div>

    <!-- Change Password section -->
    <div id="changePasswordSection" class="section" style="display: none">
      <h2>Change Password</h2>
      <form
        id="changePasswordForm"
        method="POST"
        action="{% url 'user_profile' %}"
      >
        {% csrf_token %}
        <label for="oldPassword">Old Password:</label>
        <input
          type="password"
          id="oldPassword"
          name="old_password"
          required
        /><br />

        <label for="newPassword">New Password:</label>
        <input
          type="password"
          id="newPassword"
          name="new_password1"
          required
        /><br />

        <label for="confirmPassword">Confirm Password:</label>
        <input
          type="password"
          id="confirmPassword"
          name="new_password2"
          required
        /><br />

        <button class="button" type="submit" name="changePassword">Update Password</button>
      </form>
    </div>

    <!--Pending Bookings Section-->
    <div id="pendingSection" class="section" style="display: none">
      <h3>Pending Bookings</h3>
      {% if pending_bookings %}
      <table id="pendingBookingDetailsTable">
        <thead>
          <tr>
            <th>Car Detail</th>
            <th>Renter</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in pending_bookings %}
          <tr>
            <td>{{ booking.car_detail.car_type }} - {{booking.car_detail.car_model}}</td>
            <td>{{ booking.car_detail.renter }}</td>
            <td>{{ booking.start_date }}</td>
            <td>{{ booking.end_date }}</td>
            <td>{{ booking.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>You don't have any pending bookings.</p>
      {% endif %}
    </div>

    <!--Approved Bookings Section-->
    <div id="approvedSection" class="section" style="display: none">
      <h3>Approved Bookings</h3>
      {% if approved_bookings %}
      <table id="approvedBookingDetailsTable">
        <thead>
          <tr>
            <th>Car Detail</th>
            <th>Renter</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for booking in approved_bookings %}
          <tr>
            <td>{{ booking.car_detail.car_type }} - {{booking.car_detail.car_model}}</td>
            <td>{{ booking.car_detail.renter }}</td>
            <td>{{ booking.start_date }}</td>
            <td>{{ booking.end_date }}</td>
            <td>{{ booking.status }}</td>
            <td>
              <form action="{% url 'payment_mode' booking.order_id %}">
                <button type="submit">Pay</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>You don't have any approved bookings.</p>
      {% endif %}
    </div>

    <!-- Paid Bookings Section -->
    <div id="paidSection" class="section" style="display: none">
      <h3>Paid Bookings</h3>
      {% if paid_bookings %}
      <table id="paidBookingDetailsTable">
        <thead>
          <tr>
            <th>Car Detail</th>
            <th>Renter</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in paid_bookings %}
          <tr>
            <td>{{ booking.car_detail.car_type }} - {{booking.car_detail.car_model}}</td>
            <td>{{ booking.car_detail.renter }}</td>
            <td>{{ booking.start_date }}</td>
            <td>{{ booking.end_date }}</td>
            <td>{{ booking.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>You don't have any paid bookings.</p>
      {% endif %}
    </div>

    <!--Completed Bookings Section-->
    <div id="completedSection" class="section" style="display: none">
      <h3>Completed Bookings</h3>
      {% if completed_bookings %}
      <table id="completedBookingDetailsTable">
        <thead>
          <tr>
            <th>Car Detail</th>
            <th>Renter</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in completed_bookings %}
          <tr>
            <td>{{ booking.car_detail.car_type }} - {{booking.car_detail.car_model}}</td>
            <td>{{ booking.car_detail.renter }}</td>
            <td>{{ booking.start_date }}</td>
            <td>{{ booking.end_date }}</td>
            <td>{{ booking.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>You don't have any completed bookings.</p>
      {% endif %}
    </div>
  </div>

  <script>
    function showImage(imageUrl) {
    console.log(imageUrl);
    // Create a modal container
    var modal = document.createElement('div');
    modal.classList.add('modal');

    // Create image element
    var img = document.createElement('img');
    img.src = imageUrl;
    img.alt = 'License Photo';

    // Append image to modal
    modal.appendChild(img);

    // Append modal to body
    document.body.appendChild(modal);

    // Close modal when clicked outside image
    modal.onclick = function() {
      modal.remove();
    };
  }

    function closePopup(id) {
      document.getElementById(id).style.display = "none";
    }

    // Adding event listeners for buttons
    document.addEventListener("DOMContentLoaded", function () {
      var editProfileBtn = document.getElementById("editProfileBtn");
      var editProfileForm = document.getElementById("editProfileForm");
      var changePasswordBtn = document.getElementById("changePasswordBtn");
      var changePasswordSection = document.getElementById(
        "changePasswordSection"
      );
      var profileSection = document.getElementById("profileSection");
      var profileBtn = document.getElementById("profileBtn");
      var addCar = document.getElementById("addCarPopup");
      var addBtn = document.getElementById("car-add-btn");
      var myCarBtn = document.getElementById("myCarBtn");
      var myCarSection = document.getElementById("myCarSection");
      var myBookingsBtn = document.getElementById("myBookingsBtn");
      var myBookingsDropdown = document.getElementById("myBookingsDropdown");
      var pendingBtn = document.getElementById("pendingBtn");
      var approvedBtn = document.getElementById("approvedBtn");
      var paidBtn = document.getElementById("paidBtn");
      var completedBtn = document.getElementById("completedBtn");
      var removeCarBtn = document.getElementById("removeCarBtn");
      var addCarForm = document.getElementById("addCarForm");

      profileBtn.addEventListener("click", function () {
        editProfileForm.style.display = "none";
        changePasswordSection.style.display = "none";
        profileSection.style.display = "block";
        myBookingsDropdown.style.display = "none";
        pendingSection.style.display = "none";
        approvedSection.style.display = "none";
        paidSection.style.display = "none";
        completedSection.style.display = "none";
      });

      editProfileBtn.addEventListener("click", function () {
        editProfileForm.style.display = "block";
        changePasswordSection.style.display = "none";
        profileSection.style.display = "block";
        myBookingsDropdown.style.display = "none";
        pendingSection.style.display = "none";
        approvedSection.style.display = "none";
        paidSection.style.display = "none";
        completedSection.style.display = "none";
      });

      changePasswordBtn.addEventListener("click", function () {
        editProfileForm.style.display = "none";
        changePasswordSection.style.display = "block";
        profileSection.style.display = "block";
        myBookingsDropdown.style.display = "none";
        pendingSection.style.display = "none";
        approvedSection.style.display = "none";
        paidSection.style.display = "none";
        completedSection.style.display = "none";
      });


      // Event listener for My Bookings button
      myBookingsBtn.addEventListener("click", function () {
        // Toggle the display of the dropdown menu
        if (myBookingsDropdown.style.display === "none") {
          myBookingsDropdown.style.display = "block";
        } else {
          myBookingsDropdown.style.display = "none";
        }

        // Hide all other sections
        editProfileForm.style.display = "none";
        changePasswordSection.style.display = "none";
        profileSection.style.display = "none";


        // Event listener for dropdown buttons
        pendingBtn.addEventListener("click", function () {
          // Show pending section, hide others
          document.getElementById("pendingSection").style.display = "block";
          document.getElementById("approvedSection").style.display = "none";
          document.getElementById("paidSection").style.display = "none";
          document.getElementById("completedSection").style.display = "none";
          pendingBtn.classList.add("active");
          paidBtn.classList.remove("active");
          approvedBtn.classList.remove("active");
          completedBtn.classList.remove("active");
        });

        // Event listener for dropdown buttons
        approvedBtn.addEventListener("click", function () {
          // Show approved section, hide others
          document.getElementById("approvedSection").style.display = "block";
          document.getElementById("pendingSection").style.display = "none";
          document.getElementById("paidSection").style.display = "none";
          document.getElementById("completedSection").style.display = "none";
          pendingBtn.classList.remove("active");
          paidBtn.classList.remove("active");
          approvedBtn.classList.add("active");
          completedBtn.classList.remove("active");
        });

        // Event listener for the Paid Bookings section
        paidBtn.addEventListener("click", function () {
          // Show paid section, hide others
          document.getElementById("paidSection").style.display = "block";
          document.getElementById("pendingSection").style.display = "none";
          document.getElementById("approvedSection").style.display = "none";
          document.getElementById("completedSection").style.display = "none";
          pendingBtn.classList.remove("active");
          paidBtn.classList.add("active");
          approvedBtn.classList.remove("active");
          completedBtn.classList.remove("active");
        });

        // Event listener for Completed Bookings button
        completedBtn.addEventListener("click", function () {
          // Show completed section, hide others
          document.getElementById("completedSection").style.display = "block";
          document.getElementById("paidSection").style.display = "none";
          document.getElementById("pendingSection").style.display = "none";
          document.getElementById("approvedSection").style.display = "none";
          pendingBtn.classList.remove("active");
          paidBtn.classList.remove("active");
          approvedBtn.classList.remove("active");
          completedBtn.classList.add("active");
        });

        pendingBtn.click();
      });
    });
  </script>

  <style>
    :root {
      --indigo: #16425b;
      --lapis: #2f6690;
      --cerulean: #3a7ca5;
      --skyblue: #81c3d7;
      --platinum: #d9dcd6;
      --darkgray: #b4b4b3;
      --red: #f44336;
      --green: #4caf50;
      --darkgreen: darkgreen;
      --crimson: crimson;
      --white: #ffffff;
    }

    body {
      font-family: "Montserrat", sans-serif;
    }

    .main-container {
      width: 90vw;
      margin: 0 5%;
      margin-top: 9.8vh;
      min-height: 65.7vh;
    }

    .details {
      padding: 40px;
    }

    h2,
    h3 {
      color: var(--indigo);
    }

    .button {
      padding: 8px 16px;
      border: none;
      background-color: var(--lapis);
      color: var(--platinum);
      cursor: pointer;
      border-radius: 5px;
      margin-right: 10px;
      font-size: medium;
      margin-top: 20px;
    }

    .button:hover {
      background-color: var(--indigo);
    }

    .section {
      margin-top: 20px;
    }

    form {
      margin-top: 10px;
    }

    form label {
      display: block;
      margin-bottom: 5px;
    }

    form input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }

    form button {
      padding: 8px 20px;
      background-color: var(--indigo);
      color: var(--white);
      border: none;
      cursor: pointer;
    }

    form button:hover {
      background-color: var(--lapis);
    }

    /* Customizing alert colors */
    .alert-danger {
      color: var(--red);
      font-weight: bold;
    }

    .alert-success {
      color: var(--green);
      font-weight: bold;
    }

    /* Adjusting message display */
    .message {
      margin-top: 20px;
      max-width: 300px;
      word-wrap: break-word; /* Allow long messages to wrap */
    }

    #addCarPopup {
      display: none;
    }

    #close {
      float: right;
      font-size: 30px;
      cursor: pointer;
    }

    #car-add-btn {
      margin-top: 2vh;
      background-color: var(--lapis);
      padding: 8px 27px;
      border: none;
      color: var(--white);
      cursor: pointer;
      border-radius: 5px;
      margin: 10px 0px 10px;
      font-size: medium;
    }

    #car_done {
      margin-top: 2vh;
      background-color: var(--green);
      padding: 8px 27px;
      border: none;
      color: var(--white);
      cursor: pointer;
      border-radius: 5px;
      margin: 10px 0px 10px;
      font-size: medium;
    }

    #car_done:hover {
      background-color: var(--darkgreen);
    }

    /* CSS for table */
    #carDetailsTable {
      width: 100%;
      border-collapse: collapse;
    }

    #carDetailsTable th,
    #carDetailsTable td {
      border: 1px solid #dddddd;
      padding: 8px;
      text-align: left;
    }

    #carDetailsTable th {
      background-color: #f2f2f2;
    }

    #myCarSection {
      margin-top: 30px;
    }

    #carDetailsTable {
      margin-top: 15px;
    }

    #bookingDetailsTable {
      width: 100%;
      border-collapse: collapse;
    }

    #bookingDetailsTable th,
    #bookingDetailsTable td {
      border: 1px solid #dddddd;
      padding: 8px;
      text-align: left;
    }

    #bookingDetailsTable th {
      background-color: #f2f2f2;
    }

    #myBookingsSection {
      margin-top: 30px;
    }

    #bookingDetailsTable {
      margin-top: 15px;
    }

    #myBookingsDropdown {
      margin-top: 30px;
    }

    /* CSS for dropdown buttons */
    .booking-btn {
      padding: 11px 22px; /* Increasing padding to make the buttons wider */
      margin-right: 15px; /* Adjusting margin to provide spacing between buttons */
      border: 1px solid var(--indigo); /* Adding border for better visibility */
      background-color: var(--platinum); /* Changing background color */
      color: var(--indigo); /* Changing text color */
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }

    /* Hover effect */
    .booking-btn:hover {
      background-color: var(--indigo);
      color: var(--platinum);
    }

    /* Active state */
    .active {
      background-color: var(--lapis);
      color: var(--platinum);
    }

    .popup-content {
      text-align: center;
      background-color: #ffff;
      padding: 20px;
      border-radius: 10px;
      color: var(--indigo); /* Text color */
    }

    .popup-content h2 {
      margin-top: 0;
    }

    .popup-content p {
      margin-bottom: 20px;
    }

    .close {
      position: absolute;
      top: 2px;
      right: 15px;
      color: var(--indigo); /* Close button color */
      font-size: 30px;
      cursor: pointer;
    }


    #pendingBookingDetailsTable,
    #approvedBookingDetailsTable,
    #paidBookingDetailsTable,
    #completedBookingDetailsTable {
      width: 100%;
      border-collapse: collapse;
    }

    #pendingBookingDetailsTable th,
    #approvedBookingDetailsTable th,
    #paidBookingDetailsTable th,
    #completedBookingDetailsTable th,
    #pendingBookingDetailsTable td,
    #approvedBookingDetailsTable td,
    #paidBookingDetailsTable td,
    #completedBookingDetailsTable td {
      border: 1px solid #dddddd;
      padding: 8px;
      text-align: left;
    }

    #pendingBookingDetailsTable th,
    #approvedBookingDetailsTable th,
    #paidBookingDetailsTable th,
    #completedBookingDetailsTable th {
      background-color: #f2f2f2;
    }

    #pendingBookingDetailsTable,
    #approvedBookingDetailsTable,
    #paidBookingDetailsTable,
    #completedBookingDetailsTable {
      margin-top: 15px;
    }

    .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  #license_photo{
    height: 400px;
    width: 600px;
  }
  </style>


</div>
{% endblock %}